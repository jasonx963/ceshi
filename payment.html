<!DOCTYPE html>
<html lang="es-MX">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pagar pedido</title>
  <meta name="description" content="Pago por transferencia bancaria con comprobante de iPhone 16 / 16 Pro / 16 Pro Max."/>
  <style>
    :root{
      --ink:#1d1d1f; --muted:#6e6e73; --hair:#d2d2d7; --panel:#f5f5f7; --ok:#0a7d33; --warn:#b91c1c;
      --blue:#0077ff; --bg:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{text-decoration:none;color:var(--blue)}
    .wrap{max-width:920px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    h1{margin:0;font-size:28px}
    .muted{color:var(--muted)}
    .card{background:#fff;border:1px solid var(--hair);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.05);padding:16px;margin:12px 0}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.grid2{grid-template-columns:1fr}}
    .kv{display:flex;align-items:center;justify-content:space-between;border:1px dashed var(--hair);border-radius:12px;padding:10px 12px;margin:8px 0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    input,textarea{width:100%;padding:10px 12px;border:1px solid var(--hair);border-radius:10px;font-size:14px}
    button{cursor:pointer;border:0;border-radius:10px;padding:10px 12px;font-weight:700}
    .btn{background:#111;color:#fff}
    .btn.blue{background:var(--blue)}
    .btn.ghost{background:#f3f4f6;color:#111}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .actions .btn{flex:1;min-width:160px}
    .ok{color:var(--ok);font-weight:700}
    .warn{color:var(--warn);font-weight:700}
    .previewBox{border:1px dashed var(--hair);border-radius:12px;display:flex;align-items:center;justify-content:center;min-height:160px;overflow:hidden}
    .previewBox img{max-width:100%;max-height:360px;object-fit:contain;display:block}
    .pdfTag{font-weight:800;color:#fff;background:#444;border-radius:8px;padding:8px 10px}
    .tips{font-size:13px;color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Pago seguro</h1>
      <a class="muted" href="./index.html">‚Üê Regresar</a>
    </header>

    <!-- Resumen del pedido -->
    <div id="orderInfo" class="card">
      <div class="row">
        <div>
          <div class="muted">N√∫mero de pedido</div>
          <div id="oid" class="mono">-</div>
        </div>
        <div>
          <div class="muted">Precio</div>
          <div id="pprice" class="mono">-</div>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <div class="muted">Producto</div>
          <div id="pname" class="mono">-</div>
        </div>
        <div>
          <div class="muted">ID del producto</div>
          <div id="pid" class="mono">-</div>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <div class="muted">Almacenamiento</div>
          <div id="pstorage" class="mono">-</div>
        </div>
        <div>
          <div class="muted">Color</div>
          <div id="pcolor" class="mono">-</div>
        </div>
      </div>
    </div>

    <!-- Informaci√≥n bancaria -->
    <div class="card">
      <h3 style="margin:0 0 8px;">Informaci√≥n bancaria</h3>
      <p class="muted">Copia exactamente estos datos para hacer la transferencia. Despu√©s, sube el comprobante.</p>

      <div class="kv">
        <div>
          <b>Banco</b>
          <div class="muted mono" id="bankName">BANCOPPEL</div>
        </div>
        <button class="btn ghost" data-copy="#bankName">Copiar</button>
      </div>

      <div class="kv">
        <div>
          <b>Cuenta a nombre de</b>
          <div class="muted mono" id="accountName">APPLE</div>
        </div>
        <button class="btn ghost" data-copy="#accountName">Copiar</button>
      </div>

      <div class="kv">
        <div>
          <b>CLABE</b>
          <div class="muted mono" id="clabe">137180105277652487</div>
        </div>
        <button class="btn ghost" data-copy="#clabe">Copiar</button>
      </div>

      <div class="kv">
        <div>
          <b>N√∫mero de tarjeta</b>
          <div class="muted mono" id="cardNo">4169 1614 9289 8795</div>
        </div>
        <button class="btn ghost" data-copy="#cardNo">Copiar</button>
      </div>

      <div class="actions">
        <button id="copyAll" class="btn blue">Copiar todos los datos</button>
      </div>
    </div>

    <!-- Subir comprobante -->
    <div class="card">
      <h3 style="margin:0 0 8px;">Sube el comprobante</h3>
      <p class="muted">Aceptamos JPG/PNG/PDF (m√°x. 8 MB). Aseg√∫rate de que se vea el monto, la fecha y la referencia.</p>
      <div class="grid2">
        <div>
          <input id="file" type="file" accept="image/*,application/pdf" />
          <div class="previewBox" style="margin-top:8px">
            <div id="previewHolder" class="muted">Vista previa</div>
          </div>
        </div>
        <div>
          <label class="muted" for="notes">Notas (opcional)</label>
          <textarea id="notes" rows="6" placeholder="Escribe detalles como el √∫ltimo d√≠gito del folio, hora del pago, etc."></textarea>
          <div class="actions">
            <button id="btnUpload" class="btn blue">Enviar comprobante</button>
            <button id="btnReset" class="btn ghost">Limpiar</button>
          </div>
          <div id="tip" class="tips" style="margin-top:10px">
            Consejo: Despu√©s de pagar, sube el comprobante aqu√≠. Nuestro equipo verificar√° y confirmar√° tu pedido.
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">¬øDudas?</h3>
      <p class="muted">Si necesitas ayuda, cont√°ctanos por WhatsApp con tu n√∫mero de pedido y el comprobante.</p>
      <a class="btn blue" href="https://wa.me/5215512345678" target="_blank" rel="noopener noreferrer">Contactar por WhatsApp</a>
    </div>
  </div>

  <script>
    // ========= Utiles =========
    const qs = (s, r=document) => r.querySelector(s);
    const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));
    const money = n => 'MX$' + new Intl.NumberFormat('es-MX').format(Math.round(n));

    // ========= Lee par√°metros =========
    const params = new URLSearchParams(location.search);
    const product   = params.get('product')   || '-';
    const productId = params.get('productId') || '-';
    let   storage   = params.get('storage')   || '';
    let   color     = params.get('color')     || '';
    let   price     = params.get('price')     || '';

    // ËÆ¢ÂçïÂè∑ÔºöËã•Êú™Êèê‰æõÔºåÁî®Êó∂Èó¥Êà≥+4‰ΩçÈöèÊú∫ÁîüÊàêÔºåÈÅøÂÖçË¶ÜÁõñ
    let orderId = params.get('orderId');
    if (!orderId) {
      const rnd = Math.floor(Math.random()*9000)+1000;
      orderId = 'ORD' + Date.now() + rnd;
    }

    // ========= ÊòæÁ§∫ËÆ¢ÂçïÊëòË¶Å =========
    qs('#pname').textContent    = product;
    qs('#pid').textContent      = productId;
    qs('#pstorage').textContent = storage || '-';
    qs('#pcolor').textContent   = color   || '-';
    qs('#oid').textContent      = orderId;

    // ===== Fallback de precio (15% del PVP) =====
    (function ensurePrice(){
      const db = {
        ip16:       { discount: 0.15, price: {'128GB':19999,'256GB':22499,'512GB':27499} },
        ip16pro:    { discount: 0.15, price: {'128GB':25999,'256GB':28499,'512GB':33499,'1TB':38499} },
        ip16promax: { discount: 0.15, price: {'256GB':30999,'512GB':35999,'1TB':40999} }
      };

      if ((!storage || storage==='-') && db[productId]) {
        const keys = Object.keys(db[productId].price);
        if (keys.length) storage = keys[0];
        qs('#pstorage').textContent = storage || '-';
      }

      const num = Number(price);
      if (!price || Number.isNaN(num)) {
        if (db[productId] && db[productId].price[storage]) {
          const original = db[productId].price[storage];
          price = Math.round(original * db[productId].discount);
        }
      }
      qs('#pprice').textContent = price ? money(price) : '-';
    })();

    // ========= Copiar =========
    qsa('[data-copy]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const el  = qs(btn.getAttribute('data-copy'));
        if (!el) return;
        navigator.clipboard.writeText(el.textContent.trim()).then(()=>{
          const old = btn.textContent;
          btn.textContent = '¬°Copiado!';
          setTimeout(()=>btn.textContent=old, 1200);
        });
      });
    });

    qs('#copyAll').addEventListener('click', ()=>{
      const lines = [
        'Banco: ' + qs('#bankName').textContent.trim(),
        'Cuenta a nombre de: ' + qs('#accountName').textContent.trim(),
        'CLABE: ' + qs('#clabe').textContent.trim(),
        'N√∫mero de tarjeta: ' + qs('#cardNo').textContent.trim()
      ];
      navigator.clipboard.writeText(lines.join('\n')).then(()=>{
        const btn=qs('#copyAll'); const old=btn.textContent;
        btn.textContent='¬°Copiado!'; setTimeout(()=>btn.textContent=old,1200);
      });
    });

    // ========= Vista previa =========
    const fileInput = qs('#file');
    const holder    = qs('#previewHolder');

    function showPreview(file){
      holder.innerHTML = '';
      if(!file){ holder.textContent='Vista previa'; return; }

      if(file.type === 'application/pdf'){
        const tag = document.createElement('div');
        tag.className = 'pdfTag';
        tag.textContent = 'PDF seleccionado';
        holder.appendChild(tag);
        return;
      }
      // imagen
      const img = document.createElement('img');
      holder.appendChild(img);
      const r = new FileReader();
      r.onload = e => img.src = e.target.result;
      r.readAsDataURL(file);
    }
    fileInput.addEventListener('change', ()=>{
      const f = fileInput.files && fileInput.files[0];
      showPreview(f);
    });

    // ========= Subida =========
    async function doUpload(){
      const f = fileInput.files && fileInput.files[0];
      if (!f) {
        qs('#tip').innerHTML = '<span class="warn">Por favor, selecciona un archivo primero.</span>';
        return;
      }
      if (f.size > 8*1024*1024) {
        qs('#tip').innerHTML = '<span class="warn">El archivo supera los 8 MB. Reduce el tama√±o e int√©ntalo de nuevo.</span>';
        return;
      }

      const notes = qs('#notes').value || '';
      const fd = new FormData();
      fd.append('orderId', orderId);
      fd.append('product', product);
      fd.append('storage', storage || '');
      fd.append('color',   color   || '');
      fd.append('price',   price   || '');
      fd.append('notes',   notes);      // üëà ÂíåÂêéÁ´ØÁªü‰∏Ä‰∏∫ notes
      fd.append('file',    f);          // üëà Â≠óÊÆµÂêçÂøÖÈ°ªÊòØ file

      try{
        const res  = await fetch('/api/payment-upload', { method:'POST', body: fd });
        const json = await res.json().catch(()=>({}));
        if (res.ok && json && json.ok) {
          qs('#tip').innerHTML = '<span class="ok">Comprobante enviado correctamente. Te notificaremos tras la verificaci√≥n.</span>';
          qs('#btnUpload').disabled = true;
          fileInput.disabled = true;
        } else {
          throw new Error(json && (json.message || json.error) || 'Error desconocido');
        }
      }catch(e){
        qs('#tip').innerHTML = '<span class="warn">No se pudo enviar. Intenta otra vez o cont√°ctanos por WhatsApp.</span>';
        console.error('upload error:', e);
      }
    }
    qs('#btnUpload').addEventListener('click', doUpload);

    // ========= Limpiar =========
    qs('#btnReset').addEventListener('click', ()=>{
      fileInput.value=''; showPreview(null);
      qs('#notes').value='';
      qs('#tip').textContent='Consejo: Despu√©s de pagar, sube el comprobante aqu√≠. Nuestro equipo verificar√° y confirmar√° tu pedido.';
      qs('#btnUpload').disabled=false; fileInput.disabled=false;
    });
  </script>
</body>
</html>
