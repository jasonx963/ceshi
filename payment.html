<!DOCTYPE html>
<html lang="es-MX">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pagar pedido</title>
  <style>
    :root{--text:#111;--muted:#6e6e73;--bd:#d2d2d7;--tile:#f5f5f7;--cta:#0077ff;--cta-ink:#fff}
    *{box-sizing:border-box}
    html,body{margin:0;background:#fff;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:inherit}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--bd)}
    h1{margin:0;font-size:28px}
    .muted{color:var(--muted);font-size:13px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:16px;margin-top:12px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){.grid2{grid-template-columns:1fr}}
    .kv{display:flex;align-items:center;justify-content:space-between;border:1px dashed var(--bd);border-radius:12px;padding:10px 12px;margin:8px 0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace;}
    button{cursor:pointer;border:0;border-radius:10px;padding:10px 12px;font-weight:800}
    .btn{background:var(--cta);color:var(--cta-ink)}
    .btn.ghost{background:#f2f2f2;border:1px solid var(--bd);color:#111}
    input,textarea{width:100%;padding:10px 12px;border:1px solid var(--bd);border-radius:10px;font-size:14px}
    .preview{display:block;width:100%;max-height:360px;object-fit:contain;border:1px dashed var(--bd);border-radius:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){.row{grid-template-columns:1fr}}
    .ok{color:#059669;font-weight:800}.warn{color:#b91c1c;font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Pago</h1>
      <a class="muted" href="./index.html">← Volver</a>
    </header>

    <!-- 订单概要：展示型号/存储/颜色/价格 -->
    <div class="card">
      <div class="grid2">
        <div>
          <div class="muted">Producto</div>
          <div id="pname" class="mono">-</div>
        </div>
        <div>
          <div class="muted">ID</div>
          <div id="pid" class="mono">-</div>
        </div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <div>
          <div class="muted">Almacenamiento</div>
          <div id="pstorage" class="mono">-</div>
        </div>
        <div>
          <div class="muted">Color</div>
          <div id="pcolor" class="mono">-</div>
        </div>
      </div>
      <div style="margin-top:10px">
        <div class="muted">Precio</div>
        <div id="pprice" class="mono">-</div>
      </div>
    </div>

    <!-- 银行信息 + 复制（保持你提供的数据） -->
    <div class="card">
      <h3 style="margin:0 0 8px;">Información bancaria</h3>
      <p class="muted">Copia los datos, realiza la transferencia y luego sube el comprobante.</p>

      <div class="kv">
        <div><b>Banco</b><div class="muted mono" id="bankName">BANCOPPEL</div></div>
        <button class="btn ghost" data-copy="#bankName">Copiar</button>
      </div>

      <div class="kv">
        <div><b>Cuenta a nombre de</b><div class="muted mono" id="accountName">DAYANA COLIN PÉREZ</div></div>
        <button class="btn ghost" data-copy="#accountName">Copiar</button>
      </div>

      <div class="kv">
        <div><b>CLABE</b><div class="muted mono" id="clabe">137180105271820309</div></div>
        <button class="btn ghost" data-copy="#clabe">Copiar</button>
      </div>

      <div class="kv">
        <div><b>Número de tarjeta</b><div class="muted mono" id="cardNo">4169 1614 9957 9992</div></div>
        <button class="btn ghost" data-copy="#cardNo">Copiar</button>
      </div>
    </div>

    <!-- 上传凭证 -->
    <div class="card">
      <h3 style="margin:0 0 8px;">Sube el comprobante</h3>
      <div class="row">
        <div>
          <input id="file" type="file" accept="image/*,application/pdf" />
          <div style="margin-top:8px"><img id="preview" class="preview" alt="Vista previa" /></div>
        </div>
        <div>
          <label class="muted" for="note">Notas (opcional)</label>
          <textarea id="note" rows="6" placeholder="Últimos dígitos del folio, hora del pago, etc."></textarea>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
            <button id="btnUpload" class="btn">Enviar comprobante</button>
            <button id="btnReset" class="btn ghost">Limpiar</button>
          </div>
          <div id="tip" class="muted" style="margin-top:10px">
            Consejo: Sube el comprobante aquí. Verificaremos y confirmaremos tu pedido.
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">¿Dudas?</h3>
      <p class="muted">Si necesitas ayuda, contáctanos por WhatsApp con tu número de pedido y el comprobante.</p>
      <a class="btn" href="https://wa.me/5215512345678" target="_blank" rel="noopener noreferrer">Contactar por WhatsApp</a>
    </div>
  </div>

  <script>
    // 读取参数
    const ps = new URLSearchParams(location.search);
    const product   = ps.get('product')   || '-';
    const productId = ps.get('productId') || '-';
    let   storage   = ps.get('storage')   || '';
    let   color     = ps.get('color')     || '';
    let   price     = ps.get('price')     || '';

    document.getElementById('pname').textContent    = product;
    document.getElementById('pid').textContent      = productId;
    document.getElementById('pstorage').textContent = storage || '-';
    document.getElementById('pcolor').textContent   = color   || '-';

    // 兜底价格（与首页一致：实付=原价*0.15）
    (function ensurePrice(){
      const DISCOUNT = 0.15, CURRENCY='MX$';
      const db = {
        ip16:      { price:{'128GB':19999,'256GB':22499,'512GB':27499} },
        ip16pro:   { price:{'128GB':25999,'256GB':28499,'512GB':33499,'1TB':38499} },
        ip16promax:{ price:{'256GB':30999,'512GB':35999,'1TB':40999} }
      };
      const toMoney = n => CURRENCY + new Intl.NumberFormat('es-MX').format(Math.round(n));

      if((!storage || storage==='-') && db[productId]){
        const keys = Object.keys(db[productId].price); if(keys.length) storage = keys[0];
        document.getElementById('pstorage').textContent = storage || '-';
      }
      const num = Number(price);
      if(!price || Number.isNaN(num)){
        const base = db[productId]?.price?.[storage];
        if(typeof base==='number') price = Math.round(base * DISCOUNT);
      }
      document.getElementById('pprice').textContent = price ? toMoney(price) : '-';
    })();

    // 复制
    document.querySelectorAll('[data-copy]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const el = document.querySelector(btn.getAttribute('data-copy'));
        if(!el) return;
        navigator.clipboard.writeText(el.textContent.trim()).then(()=>{
          btn.textContent='¡Copiado!'; setTimeout(()=>btn.textContent='Copiar',1200);
        });
      });
    });

    // 预览
    const fileInput = document.getElementById('file');
    const preview   = document.getElementById('preview');
    fileInput.addEventListener('change', ()=>{
      const f = fileInput.files && fileInput.files[0];
      if(!f){ preview.src=''; return; }
      const r = new FileReader(); r.onload=e=>preview.src=e.target.result; r.readAsDataURL(f);
    });

    // 提交
    async function doUpload(){
      const f = fileInput.files && fileInput.files[0];
      if(!f){ document.getElementById('tip').innerHTML='<span class="warn">Selecciona un archivo primero.</span>'; return; }
      const fd = new FormData();
      fd.append('orderId', productId);
      fd.append('product', product);
      fd.append('storage', storage||'');
      fd.append('color',   color||'');
      fd.append('price',   price||'');
      fd.append('note',    document.getElementById('note').value||'');
      fd.append('file',    f);
      try{
        const res = await fetch('/api/payment-upload',{method:'POST',body:fd});
        const js  = await res.json();
        if(!res.ok || !js?.ok) throw new Error(js?.message||('HTTP '+res.status));
        document.getElementById('tip').innerHTML='<span class="ok">Enviado correctamente. Confirmaremos pronto.</span>';
        document.getElementById('btnUpload').disabled=true; fileInput.disabled=true;
      }catch(e){
        document.getElementById('tip').innerHTML='<span class="warn">No se pudo enviar. Intenta de nuevo o usa WhatsApp.</span>';
      }
    }
    document.getElementById('btnUpload').addEventListener('click', doUpload);
    document.getElementById('btnReset').addEventListener('click', ()=>{
      fileInput.value=''; preview.src=''; document.getElementById('note').value='';
      document.getElementById('tip').textContent='Consejo: Sube el comprobante aquí. Verificaremos y confirmaremos tu pedido.';
      document.getElementById('btnUpload').disabled=false; fileInput.disabled=false;
    });
  </script>
</body>
</html>
